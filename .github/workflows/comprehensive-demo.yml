name: ğŸš€ Comprehensive Dashboard Demo

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      output_format:
        description: 'Choose output format'
        required: true
        default: 'both'
        type: choice
        options:
        - both
        - html
        - markdown

jobs:
  # Jest Tests - Both Formats
  jest-comparison:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "ğŸ¨ Jest HTML Dashboard"
            html_output: true
            suffix: "jest-html"
            icon: "ğŸ¨"
          - name: "ğŸ“ Jest Markdown Report"
            html_output: false
            suffix: "jest-markdown"
            icon: "ğŸ“"
            condition: ${{ github.event.inputs.output_format != 'html' }}
            
    name: ${{ matrix.icon }} Jest - ${{ matrix.html_output && 'HTML' || 'Markdown' }}
    if: matrix.condition != 'false'
    
    steps:
      - name: ğŸ“ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Test Dependencies
        run: |
          cd test-output
          npm install

      - name: ğŸ§ª Run Jest Tests
        run: |
          cd test-output
          npm test

      - name: ${{ matrix.icon }} Generate Test Metrics
        uses: ./
        if: always()
        with:
          report_paths: 'test-output/jest-results.json'
          test_framework: 'jest'
          html_output: ${{ matrix.html_output }}
          detailed_summary: true
          fail_on_failure: false
          cache_key_prefix: 'comprehensive-${{ matrix.suffix }}'
          artifact_suffix: '${{ matrix.suffix }}'

  # JUnit XML - Both Formats  
  junit-comparison:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "ğŸ¨ JUnit HTML Dashboard"
            html_output: true
            suffix: "junit-html"
            icon: "ğŸ¨"
          - name: "ğŸ“ JUnit Markdown Report"
            html_output: false
            suffix: "junit-markdown"
            icon: "ğŸ“"
            condition: ${{ github.event.inputs.output_format != 'html' }}
            
    name: ${{ matrix.icon }} JUnit - ${{ matrix.html_output && 'HTML' || 'Markdown' }}
    if: matrix.condition != 'false'
    
    steps:
      - name: ğŸ“ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ“„ Display Sample JUnit XML
        run: |
          echo "ğŸ“‹ Using sample JUnit XML file:"
          echo "File: examples/junit-sample.xml"
          echo "Contents:"
          cat examples/junit-sample.xml

      - name: ${{ matrix.icon }} Generate JUnit Metrics
        uses: ./
        if: always()
        with:
          report_paths: 'examples/junit-sample.xml'
          test_framework: 'junit'
          html_output: ${{ matrix.html_output }}
          detailed_summary: true
          fail_on_failure: false
          cache_key_prefix: 'comprehensive-${{ matrix.suffix }}'
          artifact_suffix: '${{ matrix.suffix }}'

  # Playwright Tests - Both Formats
  playwright-comparison:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "ğŸ¨ Playwright HTML Dashboard"
            html_output: true
            suffix: "playwright-html"
            icon: "ğŸ¨"
          - name: "ğŸ“ Playwright Markdown Report"
            html_output: false
            suffix: "playwright-markdown"
            icon: "ğŸ“"
            condition: ${{ github.event.inputs.output_format != 'html' }}
            
    name: ${{ matrix.icon }} Playwright - ${{ matrix.html_output && 'HTML' || 'Markdown' }}
    if: matrix.condition != 'false'
    
    steps:
      - name: ğŸ“ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ğŸ§ª Run Playwright Tests
        run: npx playwright test --reporter=json
        if: always()
        env:
          PLAYWRIGHT_JSON_OUTPUT_NAME: playwright-results.json

      - name: ğŸ“ List Generated Files
        run: |
          echo "ğŸ“‹ Generated test files:"
          ls -la *.json || echo "No JSON files found in root"
          echo ""
        if: always()

      - name: ${{ matrix.icon }} Generate Playwright Metrics
        uses: ./
        if: always()
        with:
          report_paths: 'playwright-results.json'
          test_framework: 'playwright'
          html_output: ${{ matrix.html_output }}
          detailed_summary: true
          fail_on_failure: false
          cache_key_prefix: 'comprehensive-${{ matrix.suffix }}'
          artifact_suffix: '${{ matrix.suffix }}'

  # Summary Job
  demo-results:
    runs-on: ubuntu-latest
    needs: [jest-comparison, junit-comparison, playwright-comparison]
    if: always()
    name: ğŸ“Š Demo Results Summary
    
    steps:
      - name: ğŸ“Š Display Comprehensive Demo Results
        run: |
          echo "ğŸ‰ Comprehensive Dashboard Demo Completed!"
          echo ""
          echo "âœ… Frameworks Tested:"
          echo "  ğŸ§ª Jest (JSON results)"
          echo "  ğŸ“„ JUnit XML (XML results)"  
          echo "  ğŸ­ Playwright (JSON results)"
          echo ""
          echo "ğŸ¨ Output Formats Demonstrated:"
          echo "  ğŸ“± HTML Dashboard - Modern, responsive, interactive"
          echo "  ğŸ“ Markdown Report - GitHub-native, structured"
          echo ""
          echo "ğŸ”„ Both formats show IDENTICAL information:"
          echo "  â€¢ Test Execution Details with pass/fail ratios"
          echo "  â€¢ Comprehensive metrics table (Current/Previous/Trend)"
          echo "  â€¢ Performance insights and recommendations"
          echo "  â€¢ Slowest tests identification"
          echo "  â€¢ Flaky test detection (when applicable)"
          echo "  â€¢ Visual trend indicators"
          echo ""
          echo "ğŸ¯ Key Benefits:"
          echo "  â€¢ Consistent data across formats"
          echo "  â€¢ Choose based on your needs (visual vs. accessible)"
          echo "  â€¢ Same trend tracking and caching"
          echo "  â€¢ Artifact conflict resolution"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "  â€¢ HTML_OUTPUT_GUIDE.md - Complete HTML guide"
          echo "  â€¢ WORKFLOW_EXAMPLES.md - Production examples"
          echo "  â€¢ README.md - Quick start guide"
